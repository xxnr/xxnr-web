<div class="filter" style="padding-bottom:9px">
	<div class="container">
		<div class="caption"><span class="fa fa-users mr5"></span> @(会员管理)</div>
		<div class="row">
			<div class="col-md-3 col-sm-6 m">
				<div data-component="textbox" data-component-path="users.filter.search" data-placeholder="@(姓名/昵称/手机号)" data-control-icon="fa-search">@(查询用户)</div>
				<div class="help" data-component="template" data-component-path="users.info"><script type="text/html">{{ count | pluralize(@('items','item','items','items')) }} / {{ pages | pluralize(@('pages','page','pages','pages')) }}</script></div>
			</div>
            <div class="col-md-3" col-sm-6 m>
                <div name="user_verify" data-component="dropdown" data-component-path="users.filter.query" data-options="@(全部)|0;@(未认证)|1;@(申请认证)|3;@(种植大户)|4;@(村级经销商)|5;@(乡镇经销商)|6;@(县级经销商)|7">@(认证用户)</div>
            </div>
		</div>
	</div>
</div>

<div class="container">
	<div data-component="grid" data-component-path="users.grid" data-max="auto" data-options-page="@(Page: #)" data-options-button="@(查看更多用户)" data-component-id="users.grid" data-talble-width="">
		<!-- <tr>
			<td>@(会员)</td>
			<td style="width:220px" class="hidden-xs fs11">@(账号)</td>
			<td style="width:120px" class="hidden-xs fs11">@(昵称)</td>
			<td style="width:120px" class="hidden-xs fs11">@(积分)</td>
			<td style="width:200px" class="ui-right hidden-xs">@(注册时间)</td>
			<td style="width:80px" class="ui-right">@(操作)</td>
		</tr> -->
		<script type="text/html">
		<tr>
			<td style="width:40px" class="silver hidden-xs">$index</td>
			<td style="width:120px" class="hidden-xs fs11" data-title="会员">{{ id }}</td>
            <td style="width:120px" class="hidden-xs fs11" data-title="手机号">{{ account }}</td>
            <td style="width:120px" class="hidden-xs fs11" data-title="姓名">{{ name }}</td>
			<td style="width:120px" class="hidden-xs fs11" data-title="昵称">{{ nickname }}</td>
            <td style="width:60px" class="hidden-xs fs11" data-title="积分">{{ score }}</td>
            <td style="width:100px" class="hidden-xs fs11" data-title="注册来源">{{ registerAgent }}</td>
            <td style="width:160px" class="ui-right hidden-xs" data-title="注册时间">
				{{ if datecreated }}
                    {{ if datecreated.charAt(datecreated.length-1) !== 'Z' }}
                        {{ datecreated }}
                    {{ else }}
                        {{ datecreated | format('yyyy-MM-dd hh:mm:ss') }}
                    {{ fi }}
				{{ fi }}
			</td>
            <td style="width:100px" class="hidden-xs fs11" data-title="新农代表昵称">{{if inviter }} {{ inviter.nickname }} {{fi}}</td>
            <td style="width:100px" class="hidden-xs fs11" data-title="认证用户">{{ typeNameVerified }}</td>
            <td style="width:80px" class="ui-right" data-title="会员信息">
                <button name="edit" title="@(Show)"><span class="fa fa-search"></span></button>
            </td>
            <td style="width:80px" class="ui-right" data-title="订单信息">
                <button name="order" title="@(Show)"><span class="fa fa-search"></span></button>
            </td>
		</tr>
		</script>
	</div>
	<!-- <button name="remove" title="@(Remove)"><span class="fa fa-times"></span></button> -->
</div>
<div data-component="form" data-title="@(会员信息)" data-component-path="common.form" data-if="value === 'users'" data-width="900px" data-component-id="users.form">
	<br />
	<div data-component="template" data-component-path="users.form" class="padding" style="padding-bottom:0">
		<script type="text/html">
		<table class="table table-bordered" border="0">
			<tbody>
				<tr>
					<td class="col-xs-4 active">@(# id)</td>
					<td>{{ id }}</td>
				</tr>
				<tr>
					<td class="col-xs-4 active">@(账户)</td>
					<td>{{ account }}</td>
				</tr>
				<tr>
					<td class="col-xs-4 active">@(姓名)</td>
					<td>{{ name }}</td>
				</tr>
				<tr>
					<td class="col-xs-4 active">@(所在地区)</td>
					<td>{{ addressShow }}</td>
				</tr>
				<tr>
					<td class="col-xs-4 active">@(昵称)</td>
					<td>{{ nickname }}</td>
				</tr>
				<tr>
					<td class="col-xs-4 active">@(用户积分)</td>
					<td>{{ score }}</td>
				</tr>
				{{ if datecreated }}
				<tr>
					<td class="col-xs-4 active">@(注册时间)</td>
					<td>
					{{ if datecreated.charAt(datecreated.length-1) !== 'Z' }}
						{{ datecreated }}
					{{ else }}
						{{ datecreated | format('yyyy-MM-dd hh:mm:ss') }}
					{{ fi }}
					</td>
				</tr>
				{{ fi }}
				<tr>
					<td class="col-xs-4 active">@(注册设备)</td>
					{{ if registerAgent }}
						<td>{{ registerAgent }}</td>
					{{ else }}
						<td>@(无)</td>
					{{ fi }}
				</tr>
				<tr>
					<td class="col-xs-4 active">@(性别)</td>
					{{ if sex == 0 }}
						<td>@(男)</td>
					{{ else }}
						<td>@(女)</td>
					{{ fi }}
				</tr>
                <tr>
                    <td class="col-xs-4 active">@(已认证类型)</td>
                    <td>{{ typeNameVerified }}</td>
                </tr>
			</tbody>
		</table>
		</script>
	</div>

	<div class="padding" style="padding-bottom:0">
		<!--<div class="row">-->
			<!--<div class="col-md-4 m">-->
				<!--<div data-component="textbox" data-component-path="users.form.name">@(姓名)</div>-->
			<!--</div>-->
            <!--<div class="col-md-4 m">-->
                <!--<div data-component="textbox" data-component-path="users.form.nickname">@(昵称)</div>-->
            <!--</div>-->
		<!--</div>-->
        <div class="row">
            <div class="col-md-4 m">
                @(认证用户类型：)
            </div>
         </div>
        <div class="row">
            <div class="col-md-4 m">
                <div data-component="dropdown" data-component-path="users.form.type" data-source="users.usertypes" data-source-value="value" data-source-text="text"></div>
            </div>
            <div class="col-md-4 m">
                <!-- data-options="@(未认证)|1;@(种植大户)|2;@(村级经销商)|3;@(乡镇经销商)|4;@(县级经销商)|5"-->
                <div data-component="checkbox" data-component-path="users.form.isVerified">@(<b>已认证</b>)</div>
            </div>
        </div>
	</div>
	<hr />

	<div data-component="error" data-component-path="users.response"></div>
	<div class="ui-form-buttons">
		<div data-component="validation" data-component-path="users.form">
			<button name="submit">@(提交)</button>
		</div>
		<button name="cancel">@(取消)</button>
	</div>
</div>
<div data-component="form" data-title="@(订单信息)" data-component-path="common.form" data-if="value==='users_orders'" data-width="900px" data-component-id="users.orders.form">
    <div data-component="template" class="padding" data-component-path="users.orders.form">
        <script type="text/html">
            <table class="table table-bordered" border="0">
                <tbody>
                    <tr>
                        <td class="col-xs-4 active">@(# 订单数)</td>
                        <td>{{ count }}</td>
                    </tr>
                </tbody>
            </table>
            <div class="silver"><span class="fa fa-shopping-cart"></span> <strong>@(已支付订单列表)</strong>:</div>
            <table class="table table-bordered checkoutlist" border="0">
                <tr>
                    <td class="col-xs-2 hidden-xs ui-right">@(订单编号)</td>
                    <td class="ui-right col-xs-3 hidden-xs">
                        <ul>
                            <li><div class="product-name">@(订单商品)</div><sapn>@((数量x))</sapn></li>
                        </ul>
                    </td>
                    <td class="ui-right col-xs-2">@(创建时间)</td>
                    <td class="ui-right col-xs-2">@(收货人电话)</td>
                    <td class="ui-right col-xs-2">@(支付金额)</td>
                </tr>
                {{ foreach order in items }}
                    {{ if order.payStatus=='1'}}
                        <tr>
                            <td class="col-xs-2 hidden-xs ui-right">{{ order.id }}</td>
                            <td class="ui-right col-xs-4 hidden-xs">
                                <ul>
                            {{ foreach product in order.products }}
                                    <li><div class="product-name" title="{{product.name}}">{{ product.name }}</div><sapn>({{ product.count }}x)</sapn></li>
                            {{ end }}
                                </ul>
                            </td>
                            <td class="ui-right col-xs-3 hidden-xs">{{ order.dateCreated | format('yyyy-MM-dd hh:mm:ss') }}</td>
                            <td class="ui-right col-xs-2 hidden-xs">{{ order.consigneePhone }}</td>
                            <td class="ui-right col-xs-2 hidden-xs">{{ order.deposit }}</td>
                        </tr>
                    {{ fi }}
                {{ end }}
            </table>
            <button name="more-orders" class="ui-grid-more">
                <span class="fa fa-plus-circle"></span>
                @(查看更多订单)
            </button>
        </script>
    </div>
</div>
<script>
	var users = {};

	users.filter = {};
	users.filter.page = 1;
	users.filter.type = 0;
    users.filter.query = 0;

	users.grid = [];
	users.form = {};
	users.info = {};
    users.usertypes = [];
	users.response;

    ON("#users.query", function(component){

    });

	ON('#users.grid', function(component) {

		// Max items per page
		users.filter.max = component.max;
		users_refresh(true);

		component.click = function(index, row, button) {
			switch ($(button).attr('name')) {
				case 'edit':
					$.components.GET(managerurl + '/api/users/' + row.id, null, function(response) {
                        if(response.code!=1000){
                            alert(response.message);
                            return;
                        }

                        response.user.typeNameVerified = usertypes[response.user.typeVerified];
						response.user.addressShow = '';
						if(response.user.address){
							if(response.user.address.province){
								response.user.addressShow += response.user.address.province.name;
							}

							if(response.user.address.city){
								response.user.addressShow += response.user.address.city.name;
							}

							if(response.user.address.county){
								response.user.addressShow += response.user.address.county.name;
							}

							if(response.user.address.town){
								response.user.addressShow += response.user.address.town.name;
							}
						}

						SET('users.form', $.extend({}, response.user), true);
						SET('users.response', null);
						SET('common.form', 'users');
					});
					break;

				// case 'remove':
				// 	if (!confirm('@(Do you want to remove selected user?)'))
				// 		return;
				// 	$.components.DELETE(managerurl + '/api/users', { id: row.id }, function() {
				// 		users_refresh(true);
				// 	});
				// 	break;
                case 'order':
                    $.components.GET(managerurl + '/api/orders/?buyer=' + row.id, null, function(response) {
                        console.log(response);
                        SET('users.orders.form', response);
                        SET('common.form','users_orders');
                    });
                    break;
			}
		};

		component.next = function(page) {
			users.filter.page = page;
			users_refresh();
		};
	});

	ON('#users.form', function(component) {
		// Submits user form
		component.submit = function(hide) {
			$.components.PUT(managerurl + '/api/users/', users.form, function(response) {

				// Error handling
				SET('users.response', response);
				if (response instanceof Array)
					return;

				hide();
				users_refresh(true);
				success();
			});
		};
	});

    ON('#orders.form', function(component){
        component.click = function(index, row, button){

        }
    });

	// Method refreshes grid
	function users_refresh(reset) {

		if (reset) {
			users.filter.page = 1;
			users.grid = [];
		}

		$.components.GET(managerurl + '/api/users/', users.filter, function(response) {
            response.items.forEach(function(item){
                if(item.type === item.typeVerified && item.type !=='1' ){
                    item.typeNameVerified = usertypes[item.type];
                    console.log(item.typeNameVerified);
                }
            });

			SET((reset ? '' : '+') + 'users.grid', response.items);
			if (!reset)
				return;
			users.info.count = response.count;
			users.info.pages = response.pages;
			UPDATE('users.info');
		});

        var user_types = [];
        for(var i in usertypes){
            if(usertypes.hasOwnProperty(i)) {
                var usertype = {value: i, text: usertypes[i]};
                user_types.push(usertype);
            }
        }

        SET('users.usertypes', user_types);
	}

	// Watchs changes in user filter
	WATCH('users.filter.*', function(path, value) {
		if (NOTMODIFIED('users.filter', users.filter))
			return;
		users_refresh(path !== 'users.filter.page');
	});

	// Tangular.register('oauth2', function() {
	// 	var prop = ['idfacebook', 'idlinkedin', 'idgoogle', 'iddropbox', 'idinstagram', 'idyandex', 'idyahoo', 'idvk', 'idlive'];
	// 	var self = this;
	// 	var builder = '';
	// 	for (var i = 0, length = prop.length; i < length; i++) {
	// 		var id = self[prop[i]];
	// 		if (!id)
	// 			continue;
	// 		var icon = prop[i].replace('id', '');
	// 		switch (icon) {
	// 			case 'live':
	// 				icon = 'windows';
	// 				break;
	// 			case 'idyandex':
	// 				icon = 'search';
	// 				break;
	// 		}
	// 		builder += '<span class="mr5 fa blue fa-' + icon + '"></span>';
	// 	}

	// 	return builder;
	// });
</script>